<!DOCTYPE html>
<html  xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/layui/css/layui.css}" media="all">
    <link rel="stylesheet" th:href="@{/css/layuimini.css?v=2.0.4.2}" media="all">
    <link rel="stylesheet" th:href="@{/css/themes/default.css}" media="all">
    <link rel="stylesheet" th:href="@{/lib/font-awesome-4.7.0/css/font-awesome.min.css}" media="all">
    <style>
        .div-content{
            background-color: white;
            border-radius: 5px;
            padding: 15px;
        }
        .table-search-fieldset {
            margin: 0;
            border: 1px solid #e6e6e6;
            padding: 10px 20px 5px 20px;
            color: #6b6b6b;
        }
    </style>
</head>
<body>
<div class="layuimini-container">
    <div class="layuimini-main">
<!--         <blockquote class="layui-elem-quote">
            Layui的树形表格treeTable，支持异步加载(懒加载)、复选框联动、折叠状态记忆。<br>
            <a href="https://gitee.com/whvse/treetable-lay" target="_blank" class="layui-btn layui-btn-danger">treetable-lay</a>
        </blockquote> -->
        <div>
        <div class="layui-btn-group">
                <button class="layui-btn" id="btn-refresh">刷新</button>
            </div>
            <div class="layui-btn-group">
                <button class="layui-btn" id="btn-expand">全部展开</button>
                <button class="layui-btn layui-btn-normal" id="btn-fold">全部折叠</button>
            </div>
            <table id="munu-table" class="layui-table" lay-filter="munu-table"></table>
        </div>
    </div>
</div>
<!-- 操作列 -->
<script type="text/html" id="auth-state">
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="creat">添加平级菜单</a>
	<a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="creatsub">添加子菜单</a>
    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="edit">修改</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
</script>

    <script th:src="@{/webjars/jquery/3.5.1/jquery.min.js}" charset="utf-8"></script>
    <script th:src="@{/layui/layui.js}" charset="utf-8"></script>
    <script th:src="@{/js/lay-config.js}" charset="utf-8"></script>
    <script type="text/html" id="convertdisabled">
        {{#
            if(d.disabled == '0'){
                return '<input type="checkbox" data="'+d.sys_menu_id+'" checked="" value="ture" lay-skin="switch" lay-filter="switch" lay-text="开|关">';
            }else{
                return '<input type="checkbox" data="'+d.sys_menu_id+'" value="false" lay-skin="switch" lay-filter="switch" lay-text="开|关">';
            }
        }}
    </script>
    <script th:inline="javascript">
	var ctx = /*[[@{/}]]*/'';
    layui.use(['table', 'treetable','miniTab','form'], function () {
        var $ = layui.jquery;
        var table = layui.table;
        var treetable = layui.treetable;
        var miniTab = layui.miniTab;
        var form = layui.form;
        // 渲染表格
        var renderTable = function () {
        	layer.load(2);
        	 treetable.render({
                 treeColIndex: 1,
                 treeSpid: 0,
                 treeIdName: 'sys_menu_id',
                 treePidName: 'pid',
                 elem: '#munu-table',
                 url: ctx + 'menu/list',
                 page: false,
                 cols: [[
                     {type: 'numbers'},
                     {field: 'title', minWidth: 200, title: '菜单名称'},
                     {field: 'href', title: '菜单url'},
                     {field: 'icon' , hide : false, title: '图标', align: 'center', templet: function (d) {
                     	 return '<span class="'+d.icon+'"></span>';
                     }}, 
                     {field: 'target', title: '链接打开方式'},
                     {field: 'sort',width: 80, align: 'center', title: '排序号'},
                     {field: 'disabled', width: 80, title: '可用',templet: '#convertdisabled'},
                     
                     {field: 'remark',title: '备注信息'},  
     /*                 {
                         field: 'isMenu', width: 80, align: 'center', templet: function (d) {
                             if (d.isMenu == 1) {
                                 return '<span class="layui-badge layui-bg-gray">按钮</span>';
                             }
                             if (d.parentId == 0) {
                                 return '<span class="layui-badge layui-bg-blue">目录</span>';
                             } else {
                                 return '<span class="layui-badge-rim">菜单</span>';
                             }
                         }, title: '类型'
                     }, */
                     {templet: '#auth-state', width: 300, align: 'center', title: '操作'}
                 ]],
                 done: function () {
                     layer.closeAll('loading');
                 }
             });
        }
        
        renderTable();

        $('#btn-expand').click(function () {
            treetable.expandAll('#munu-table');
        });
		$('#btn-refresh').click(function () {
			renderTable();
        });
        $('#btn-fold').click(function () {
            treetable.foldAll('#munu-table');
        });
		function openLayerPopo(url,title){
      	  layer.open({
      		    type: 2
      		  , title: title
              , shade: 0.2
              , maxmin: true
              , shadeClose: true
              , area: ['100%', '100%']
              , content: url
      	  	  , end: function (){
      	  		renderTable();
      	  	  }
          });
          $(window).on("resize", function () {
              layer.full(index);
          });
		}
		//监听指定开关
        form.on('switch(switch)', function (data) {
           /*  layer.msg('开关checked：' + (this.checked ? 'true' : 'false'), {
                offset: '6px'
            }); */
/*               layer.msg('开关checked：' +  $(data.elem).attr("data"), {
            offset: '6px'
        	});  */
        	$.ajax({
        	    url: ctx +"menu/"+$(data.elem).attr("data")+"/status?disable="+this.checked ,
        	    type: 'PUT',
        	    success: function(result) {
        	    	layer.msg('修改成功');
        	    	renderTable();
        	    }
        	});
           // layer.tips('温馨提示：默认开启', data.othis)
        });
        //监听工具条
        table.on('tool(munu-table)', function (obj) {
            var data = obj.data;
            var layEvent = obj.event;

            if (layEvent === 'del') { 
                layer.confirm('真的删除么', function (index) {
                	$.ajax({
                	    url: ctx +"menu/"+data.sys_menu_id+"/delete",
                	    type: 'DELETE',
                	    success: function(response) {
                	    	layer.msg(response.message);
                	    	renderTable();
                	    }
                	    
                	});
                	
                });
              
            } else if (layEvent === 'edit') {
                var index = layer.open({
                    title: '修改菜单',
                    type: 2,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: ['100%', '100%'],
                    content: ctx + "menu/"+data.sys_menu_id+"/editpage",
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
                return false;
        	} else if (layEvent === 'creat') {
        		var index = layer.open({
                    title: '新建菜单',
                    type: 2,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: ['100%', '100%'],
                    content: ctx + "menu/creat?pid="+data.pid,
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
                return false;
        	} else if (layEvent === 'creatsub') {
        		var index = layer.open({
                    title: '新建菜单',
                    type: 2,
                    shade: 0.2,
                    maxmin:true,
                    shadeClose: true,
                    area: ['100%', '100%'],
                    content: ctx + "menu/creat?pid="+data.sys_menu_id,
                });
                $(window).on("resize", function () {
                    layer.full(index);
                });
                return false;
        	}
        });
    });
    
    function refreshTable(){
		var $ = layui.$;
	    $("#btn-refresh").click();
	}
</script>
</body>
</html>